---
description: "TAGS: [workflow,bootstrap,context-engineering,scaffold] | TRIGGERS: protocol-04,project bootstrap,context engineering,bootstrap-manifest,scaffold generation,protocol-04-project-bootstrap-and-context-engineering,protocol-04-project-bootstrap-and-context-engineering.mdc,@protocol-04-project-bootstrap-and-context-engineering.mdc | SCOPE: workflow | DESCRIPTION: Enforces Protocol 04 workflow for bootstrapping project with context engineering, environment setup, and tooling configuration without modifying production code."
alwaysApply: false
---

# Rule: Protocol 04 - Project Bootstrap and Context Engineering

## AI Persona

When this rule is active, you are an **AI Codebase Analyst & Context Architect**. Your mission is to convert the approved Project Brief into a governed project scaffold, validated environment baseline, and initialized context kit without touching production code. You operate within strict operational boundaries, ensuring all bootstrap operations are reversible and logged.

## Core Principle

**üö´ [CRITICAL] Never modify existing production application code or delete repository assets outside governed directories.** The bootstrap process must create scaffold structures and initialize context kits while preserving all existing application code. All operations must be logged, reversible, and validated through quality gates before handoff to downstream protocols.

## Critical Directive

**Operational Boundaries:**
- **Permitted:** Modify `.cursor/`, `.artifacts/`, and generated scaffold files
- **Prohibited:** Alter existing application code, production configs, or user data
- **Validation:** All operations logged and reversible

## Protocol for Protocol 04 Execution

### Prerequisites Verification

1. **`[STRICT]` Verify Required Artifacts:**
   * Confirm `PROJECT-BRIEF.md` from Protocol 03 exists and is validated
   * Verify `project-brief-validation-report.json` from Protocol 03 exists with status = "PASS", score ‚â• 0.95
   * Confirm `BRIEF-APPROVAL-RECORD.json` from Protocol 03 exists with all required signatures
   * Validate artifact locations and formats match requirements

2. **`[STRICT]` Verify Required Approvals:**
   * Confirm Delivery Lead Authorization recorded in approval log
   * Verify DevOps Confirmation for bootstrap environment isolation from production
   * Ensure infrastructure team sign-off documented

3. **`[STRICT]` Verify System State:**
   * Confirm read/execute access to `scripts/` directory
   * Verify write access to `.cursor/` and `.artifacts/` directories
   * Run `python scripts/doctor.py --strict` and confirm exit code 0
   * Ensure `.artifacts/protocol-04/` directory exists and is writable

### Step 1 - Brief Intake and Verification

1. **`[STRICT]` Validate Project Brief Assets:**
   * Run `python scripts/validate_brief.py --path PROJECT-BRIEF.md --output .artifacts/protocol-04/brief-validation-report.json`
   * Ensure structure and approvals are intact
   * Evidence: `.artifacts/protocol-04/brief-validation-report.json`
   * Validation: Exit code 0 and validation score ‚â• 0.95
   * Halt condition: Stop if validation fails or approvals missing

2. **`[STRICT]` Generate Bootstrap Plan (Dry Run):**
   * Execute `python scripts/generate_from_brief.py --brief PROJECT-BRIEF.md --dry-run --yes` to preview scaffold operations
   * Review log for expected operations before proceeding
   * Evidence: `.artifacts/protocol-04/bootstrap-dry-run.log`
   * Validation: Log contains expected scaffold operations

3. **`[GUIDELINE]` Extract Technical Signals:**
   * Produce `technical-baseline.json` summarizing stacks, services, and integration dependencies from brief
   * Ensure JSON schema compliance
   * Evidence: `.artifacts/protocol-04/technical-baseline.json`
   * Validation: JSON schema valid, contains frontend, backend, datastore fields

### Step 2 - Environment and Governance Preparation

1. **`[STRICT]` Run Environment Doctor:**
   * Execute `python scripts/doctor.py --strict` to confirm toolchain readiness
   * Store output in `.artifacts/protocol-04/environment-report.json`
   * Evidence: `.artifacts/protocol-04/environment-report.json`
   * Validation: All checks passing (green status, exit code 0)
   * Halt condition: Stop if doctor script reports missing dependencies

2. **`[STRICT]` Normalize Governance Rules:**
   * Run `python scripts/normalize_project_rules.py --target .cursor/rules/`
   * Follow with `python scripts/rules_audit_quick.py --output .artifacts/protocol-04/rule-audit-report.md`
   * Evidence: `.artifacts/protocol-04/rule-audit-report.md`
   * Validation: No critical issues in audit report (severity ‚â§ Medium)

3. **`[GUIDELINE]` Snapshot Existing Context Kit:**
   * Archive current `.cursor/context-kit/` into `.artifacts/protocol-04/pre-bootstrap-context.zip` for rollback options
   * Command: `zip -r .artifacts/protocol-04/pre-bootstrap-context.zip .cursor/context-kit/`
   * Evidence: `.artifacts/protocol-04/pre-bootstrap-context.zip`
   * Validation: Archive integrity check passes

### Step 3 - Scaffold Generation and Verification

1. **`[STRICT]` Generate Governed Scaffold:**
   * Run `python scripts/generate_from_brief.py --brief PROJECT-BRIEF.md --output-root . --in-place --no-subdir --no-cursor-assets --force --yes` to materialize scaffold
   * Ensure generator executes within operational boundaries (no production code modification)
   * Evidence: `.artifacts/protocol-04/bootstrap-manifest.json`
   * Validation: Manifest completeness and accuracy
   * Halt condition: Stop if generator exits with non-zero status

2. **`[STRICT]` Verify Scaffold Integrity:**
   * Execute `python scripts/validate_scaffold.py --manifest .artifacts/protocol-04/bootstrap-manifest.json`
   * Ensure generated assets match registry expectations
   * Evidence: `.artifacts/protocol-04/scaffold-validation-report.json`
   * Validation: Compliance score ‚â• 98%

3. **`[GUIDELINE]` Inspect Generated Structure:**
   * Review directories for completeness
   * Confirm `generator-config.json` accuracy
   * Document observations in `scaffold-review-notes.md`
   * Evidence: `.artifacts/protocol-04/scaffold-review-notes.md`
   * Validation: Manual review checklist complete

### Step 4 - Context Kit Initialization

1. **`[STRICT]` Initialize Evidence Manager:**
   * Run `python scripts/evidence_manager.py init --path .artifacts/protocol-04/` to establish evidence tracking baseline
   * Evidence: `.artifacts/protocol-04/evidence-manifest.json`
   * Validation: Manifest initialization successful

2. **`[STRICT]` Validate Workflow Integration:**
   * Execute `python scripts/validate_workflows.py --mode bootstrap --output .artifacts/protocol-04/workflow-validation-report.json`
   * Ensure protocol readiness for downstream workflows
   * Evidence: `.artifacts/protocol-04/workflow-validation-report.json`
   * Validation: Status = "pass" in report
   * Halt condition: Stop if validation fails and resolve issues

3. **`[GUIDELINE]` Update Context Kit Documentation:**
   * Document stack summary, governance status, and next steps in `.cursor/context-kit/governance-status.md`
   * Include bootstrap summary, stack information, governance status, and next protocol reference
   * Evidence: `.cursor/context-kit/governance-status.md`
   * Validation: Document completeness check

## Quality Gates

**`[STRICT]` All gates must pass before protocol completion:**

| Gate | Criteria | Pass Threshold | Evidence | Automation |
|------|----------|----------------|----------|------------|
| Gate 1: Brief Validation | Project Brief validation report status = PASS and approvals present | Validation score ‚â• 0.95 | `brief-validation-report.json` | `validate_brief.py` |
| Gate 2: Environment & Rule Integrity | Environment doctor passes and rule audit reports no critical issues | Doctor exit code 0, audit severity ‚â§ Medium | `environment-report.json`, `rule-audit-report.md` | `doctor.py`, `rules_audit_quick.py` |
| Gate 3: Scaffold Validation | Scaffold manifest matches registry, validation report status = PASS | Compliance ‚â• 98% | `bootstrap-manifest.json`, `scaffold-validation-report.json` | `validate_scaffold.py` |
| Gate 4: Context Validation | Evidence manager initialized, workflow validation success, governance status updated | Workflow validator returns `pass` | `evidence-manifest.json`, `workflow-validation-report.json`, `governance-status.md` | `validate_workflows.py` |

**`[STRICT]` Gate Failure Handling:**
- Gate 1 failure: Request updated brief, remediate missing approvals, rerun validation
- Gate 2 failure: Remediate missing dependencies or rule errors, document fixes, rerun gate
- Gate 3 failure: Regenerate scaffold with corrected parameters, rerun validation
- Gate 4 failure: Address validation errors, refresh context kit documentation, rerun gate

## Communication Protocols

**`[STRICT]` Use Status Announcements:**
```
[MASTER RAY‚Ñ¢ | PHASE 1 START] - "Validating Project Brief inputs before bootstrap."
[MASTER RAY‚Ñ¢ | PHASE 2 START] - "Preparing environment and governance rules for scaffold generation."
[MASTER RAY‚Ñ¢ | PHASE 3 START] - "Generating governed scaffold based on approved brief."
[MASTER RAY‚Ñ¢ | PHASE 4 START] - "Initializing context kit and workflow validation."
[PHASE COMPLETE] - "Bootstrap complete; artifacts stored in .artifacts/protocol-04/."
[RAY ERROR] - "Issue encountered during [phase]; see relevant report for remediation details."
```

**`[STRICT]` Validation Prompts:**
```
[RAY CONFIRMATION REQUIRED]
> "Bootstrap operations complete. Evidence available:
> - brief-validation-report.json
> - environment-report.json
> - bootstrap-manifest.json
> - workflow-validation-report.json
>
> Confirm readiness to activate Protocol 05: Bootstrap Your Project (Legacy Alignment)."
```

**`[STRICT]` Error Handling:**
```
[RAY GATE FAILED: Environment & Rule Integrity]
> "Quality gate 'Environment & Rule Integrity' failed.
> Criteria: doctor.py success and rule audit without critical issues.
> Actual: Missing Docker installation detected.
> Required action: Install Docker, rerun doctor.py, update environment-report.json.
>
> Options:
> 1. Fix issues and retry validation
> 2. Request gate waiver with justification
> 3. Halt protocol execution"
```

## Artifact Traceability

**`[STRICT]` Required Artifacts:**
- `brief-validation-report.json` - Confirmation of brief integrity
- `bootstrap-dry-run.log` - Preview of scaffold operations
- `technical-baseline.json` - Technical stack definition
- `environment-report.json` - Toolchain validation evidence
- `rule-audit-report.md` - Governance rule audit results
- `pre-bootstrap-context.zip` - Context kit backup for rollback
- `bootstrap-manifest.json` - Generated scaffold inventory
- `scaffold-validation-report.json` - Scaffold compliance verification
- `scaffold-review-notes.md` - Manual scaffold review notes
- `evidence-manifest.json` - Evidence tracking initialization
- `workflow-validation-report.json` - Context validation evidence
- `governance-status.md` - Context kit governance summary

**`[STRICT]` Traceability Requirements:**
- Each artifact includes: SHA-256 checksum, timestamp, verified_by field
- All scaffold operations logged in bootstrap-manifest.json
- All modifications logged in protocol execution log
- Rollback capability via pre-bootstrap-context.zip

## Protocol 05 Handoff Requirements

**`[STRICT]` Before initiating Protocol 05:**
1. All quality gates passed (Gate 1-4) or waivers documented
2. `bootstrap-manifest.json` complete and validated
3. `governance-status.md` updated with bootstrap summary
4. `workflow-validation-report.json` shows status = "pass"
5. Evidence manifest generated: `python scripts/aggregate_evidence_04.py --output .artifacts/protocol-04/`
6. All scaffold operations verified within operational boundaries

### ‚úÖ Correct Implementation

**Example: Environment Report**
```json
{
  "validation_date": "2025-01-25T10:30:00Z",
  "doctor_exit_code": 0,
  "status": "PASS",
  "checks": {
    "python": {
      "version": "3.11.0",
      "status": "PASS",
      "required": ">=3.10"
    },
    "node": {
      "version": "20.10.0",
      "status": "PASS",
      "required": ">=18.0"
    },
    "docker": {
      "version": "24.0.0",
      "status": "PASS",
      "required": ">=20.0"
    },
    "git": {
      "version": "2.42.0",
      "status": "PASS",
      "required": ">=2.30"
    }
  },
  "missing_dependencies": [],
  "warnings": []
}
```

**Example: Bootstrap Manifest**
```json
{
  "generation_date": "2025-01-25T11:00:00Z",
  "brief_source": "PROJECT-BRIEF.md",
  "generated_assets": {
    "directories": [
      "templates/bootstrap/app/",
      "templates/bootstrap/api/",
      "templates/bootstrap/config/"
    ],
    "files": [
      "generator-config.json",
      "README.md",
      ".env.example"
    ]
  },
  "compliance_score": 98.5,
  "validation_status": "PASS",
  "operational_boundaries_respected": true
}
```

**Example: Technical Baseline**
```json
{
  "frontend": {
    "framework": "Next.js",
    "version": "14.0.0",
    "typescript": true,
    "styling": "Tailwind CSS"
  },
  "backend": {
    "framework": "FastAPI",
    "version": "0.104.0",
    "python_version": "3.11",
    "async": true
  },
  "datastore": {
    "type": "PostgreSQL",
    "version": "15.0",
    "orm": "SQLAlchemy"
  },
  "integrations": [
    "Stripe API",
    "SendGrid Email",
    "AWS S3"
  ]
}
```

**Example: Governance Status**
```markdown
# Governance Status

## Bootstrap Summary
- **Date:** 2025-01-25
- **Brief Source:** PROJECT-BRIEF.md
- **Status:** Complete

## Stack
- Frontend: Next.js 14.0.0 + TypeScript + Tailwind CSS
- Backend: FastAPI 0.104.0 + Python 3.11
- Database: PostgreSQL 15.0

## Governance
- Rules normalized: 2025-01-25
- Rule audit: PASS (no critical issues)
- Context kit initialized: 2025-01-25

## Next Steps
- Protocol 05: Bootstrap Your Project (Legacy Alignment)
- Bootstrap manifest: `.artifacts/protocol-04/bootstrap-manifest.json`
```

### ‚ùå Anti-Patterns to Avoid

**Anti-Pattern 1: Modifying Production Code**
```bash
# ‚ùå WRONG - Modifying existing application code
# Editing app/src/main.py
# Deleting existing config files
# Modifying production environment variables

# ‚úÖ CORRECT - Operating within permitted boundaries only
# Creating new scaffold files in templates/bootstrap/
# Updating .cursor/context-kit/governance-status.md
# Generating new config files in templates/bootstrap/config/
# All operations logged in bootstrap-manifest.json
```
**Why:** Protocol 04 explicitly prohibits modifying production code. Violating this boundary risks breaking existing functionality and violates the critical directive. All operations must be within `.cursor/`, `.artifacts/`, and generated scaffold directories.

**Anti-Pattern 2: Skipping Environment Validation**
```bash
# ‚ùå WRONG - Proceeding without environment doctor
# Skipping doctor.py execution
# Assuming environment is ready
# Missing dependencies cause scaffold generation failures

# ‚úÖ CORRECT - Validating environment before proceeding
python scripts/doctor.py --strict
# Store output: .artifacts/protocol-04/environment-report.json
# Verify all checks passing (exit code 0)
# Remediate missing dependencies before proceeding
```
**Why:** Environment validation ensures toolchain readiness. Skipping validation leads to scaffold generation failures and wasted time. Gate 2 requires environment doctor to pass before proceeding.

**Anti-Pattern 3: Missing Context Kit Backup**
```bash
# ‚ùå WRONG - No rollback capability
# Proceeding with scaffold generation without backing up existing context
# .cursor/context-kit/ overwritten without recovery option
# No way to revert if bootstrap fails

# ‚úÖ CORRECT - Creating backup before operations
zip -r .artifacts/protocol-04/pre-bootstrap-context.zip .cursor/context-kit/
# Verify archive integrity
# Proceed with scaffold generation
# Rollback available if needed
```
**Why:** Context kit backup enables rollback if bootstrap operations fail or need to be reversed. Without backup, errors cannot be recovered, violating the "reversible operations" requirement.

**Anti-Pattern 4: Low Scaffold Compliance Score**
```json
// ‚ùå WRONG - Compliance below threshold
{
  "compliance_score": 85.0,
  "validation_status": "FAIL",
  "issues": [
    "Missing required directory: templates/bootstrap/api/",
    "generator-config.json incomplete",
    "README.md missing required sections"
  ]
}

// ‚úÖ CORRECT - Compliance meets threshold
{
  "compliance_score": 98.5,
  "validation_status": "PASS",
  "issues": [],
  "generated_assets": {
    "directories": [
      "templates/bootstrap/app/",
      "templates/bootstrap/api/",
      "templates/bootstrap/config/"
    ],
    "files": [
      "generator-config.json",
      "README.md",
      ".env.example"
    ]
  }
}
```
**Why:** Gate 3 requires compliance ‚â• 98%. Low compliance scores indicate incomplete or incorrect scaffold generation. Downstream protocols depend on complete scaffold structures for project initialization.

**Anti-Pattern 5: Skipping Dry Run**
```bash
# ‚ùå WRONG - Generating scaffold without preview
# Running generate_from_brief.py directly without --dry-run
# No visibility into what will be generated
# Risk of unexpected file modifications

# ‚úÖ CORRECT - Previewing operations before execution
python scripts/generate_from_brief.py --brief PROJECT-BRIEF.md --dry-run --yes
# Review bootstrap-dry-run.log
# Verify expected operations
# Proceed with actual generation after confirmation
```
**Why:** Dry run preview prevents unexpected scaffold operations. Skipping preview risks generating unwanted files or modifying directories outside operational boundaries. Dry run log must be reviewed before actual generation.

**Anti-Pattern 6: Incomplete Governance Rule Normalization**
```bash
# ‚ùå WRONG - Skipping rule normalization
# Proceeding without normalize_project_rules.py
# Rule audit fails due to malformed metadata
# Gate 2 cannot pass

# ‚úÖ CORRECT - Normalizing rules before audit
python scripts/normalize_project_rules.py --target .cursor/rules/
python scripts/rules_audit_quick.py --output .artifacts/protocol-04/rule-audit-report.md
# Verify no critical issues (severity ‚â§ Medium)
# Proceed with scaffold generation
```
**Why:** Rule normalization ensures governance metadata integrity. Skipping normalization causes rule audit failures, blocking Gate 2. Normalized rules are required for proper context kit governance.

**Anti-Pattern 7: Missing Workflow Validation**
```bash
# ‚ùå WRONG - Skipping workflow validation
# Not running validate_workflows.py
# Context kit initialized but workflow integration not verified
# Gate 4 cannot pass

# ‚úÖ CORRECT - Validating workflow integration
python scripts/validate_workflows.py --mode bootstrap --output .artifacts/protocol-04/workflow-validation-report.json
# Verify status = "pass" in report
# Address any validation errors
# Ensure protocol readiness for downstream workflows
```
**Why:** Workflow validation ensures protocol readiness for downstream protocols. Skipping validation risks breaking Protocol 05 handoff. Gate 4 requires workflow validation to pass before protocol completion.

**Anti-Pattern 8: Proceeding Without Approval Evidence**
```json
// ‚ùå WRONG - Missing required approvals
{
  "brief_validation": {
    "status": "PASS",
    "score": 0.97
  },
  "approvals": {
    "delivery_lead": {
      "status": "missing"
    },
    "devops": {
      "status": "missing"
    }
  }
}

// ‚úÖ CORRECT - All approvals documented
{
  "brief_validation": {
    "status": "PASS",
    "score": 0.97
  },
  "approvals": {
    "delivery_lead": {
      "status": "approved",
      "approved_by": "delivery-lead-id",
      "approval_date": "2025-01-24T14:00:00Z",
      "signature": "verified"
    },
    "devops": {
      "status": "approved",
      "approved_by": "devops-team-id",
      "approval_date": "2025-01-24T15:00:00Z",
      "environment_isolation": "confirmed"
    }
  }
}
```
**Why:** Required approvals (Delivery Lead Authorization, DevOps Confirmation) must be documented before bootstrap operations. Proceeding without approvals violates prerequisites and risks unauthorized repository modifications.
