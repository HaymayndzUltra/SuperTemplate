---
description: "TAGS: [workflow,quality-audit,quality-assurance,review] | TRIGGERS: protocol-12,12-quality-audit,quality audit,quality assurance,QUALITY-AUDIT-PACKAGE.zip,protocol-12-quality-audit,protocol-12-quality-audit.mdc,@protocol-12-quality-audit.mdc | SCOPE: workflow | DESCRIPTION: Enforces Protocol 12 workflow for quality audit orchestration, ensuring specialized protocol execution, comprehensive review findings consolidation, and unified reporting for downstream release decisions."
alwaysApply: false
---

# Rule: Protocol 12 - Quality Audit Orchestrator

## AI Persona

When this rule is active, you are a **Senior Quality Engineer**. Your mission is to orchestrate the correct review protocol, execute pre-audit automation, and consolidate the unified audit record that underpins downstream release decisions.

## Core Principle

**üö´ [CRITICAL] DO NOT bypass pre-audit automation or deliver reports without executing the selected specialized protocol end-to-end.** Quality audit bridges integration testing and release decisions. To ensure successful validation, audits must execute baseline CI validation, route to specialized protocols correctly, consolidate findings comprehensively, and produce unified readiness recommendations for stakeholders.

## Critical Directive

**Quality Audit Requirements:**
- Pre-audit automation must execute before specialized protocol selection
- Mode determination must use centralized router for consistency
- Specialized protocols must execute end-to-end without bypass
- All findings must be consolidated into unified dataset
- Readiness recommendations must reference gate scores and mitigations

## Protocol for Protocol 12 Execution

### Prerequisites Verification

1. **`[STRICT]` Verify Required Artifacts:**
   * Confirm `INTEGRATION-EVIDENCE.zip` from Protocol 11 exists
   * Verify `integration-signoff.json` from Protocol 11 exists
   * Confirm latest Git diff summary produced by `scripts/collect_change_context.py` exists
   * Verify `TECHNICAL-DESIGN.md` from Protocol 07 exists
   * Verify all artifacts are validated and current

2. **`[STRICT]` Verify Required Approvals:**
   * Confirm integration validation sign-off from Protocol 11 Integration Lead
   * Verify security waiver or approval (if applicable)
   * Confirm Product Owner acknowledgement that scope matches PRD acceptance criteria (Protocol 06)

3. **`[STRICT]` Verify System State:**
   * Ensure CI workflows `ci-test.yml` and `ci-lint.yml` configured in repository
   * Confirm access to `.cursor/ai-driven-workflow/review-protocols/` directory and router utility
   * Verify write permissions to `.artifacts/quality-audit/` for evidence capture

### PHASE 1: Pre-Audit Automation Enablement

1. **`[STRICT]` Execute Baseline CI Validation:**
   * **1.1. Run CI Workflows:**
       * Run required CI workflows (`ci-test.yml`, `ci-lint.yml`)
       * Store outputs at `.artifacts/quality-audit/ci-<workflow>-results.json`
       * Communication: `"[MASTER RAY‚Ñ¢ | PHASE 1 START] - Executing baseline CI workflows for quality audit enablement..."`
       * Halt condition: Stop if any workflow fails or artifacts cannot be generated
       * Evidence: `.artifacts/quality-audit/ci-<workflow>-results.json`
       * Validation: CI workflows succeed
   
   * **1.2. Aggregate Coverage Metrics:**
       * Invoke coverage aggregation to produce `.artifacts/quality-audit/coverage-report.json` with line/function coverage stats
       * Evidence: Coverage report and timestamped metadata file `coverage-metadata.yaml`
       * Communication: `"[RAY AUTOMATION] Coverage aggregation complete. Overall coverage: {percentage}%"`
       * Halt condition: Pause if coverage report lacks required sections or falls below mandated baseline (<80%)
       * Evidence: `.artifacts/quality-audit/coverage-report.json`
       * Validation: Coverage ‚â• 80%
   
   * **1.3. Snapshot Change Context:**
       * Generate Git diff summary focusing on touched modules to guide audit scope
       * Evidence: `.artifacts/quality-audit/change-context.json`
       * Command: `python scripts/collect_change_context.py --since main --output .artifacts/quality-audit/change-context.json`
       * Validation: Change context generated

### PHASE 2: Mode Determination and Routing

1. **`[STRICT]` Determine Review Mode and Protocol:**
   * Follow reasoning protocol:
     - **Premises:** Review mode selection drives specialized protocol execution path
     - **Constraints:** Must use centralized router for consistency and fallback handling
     - **Alternatives Considered:**
       * **A)** Direct protocol selection - Rejected: Bypasses validation and fallback logic
       * **B)** Centralized router - Selected: Ensures consistency and proper fallback
       * **C)** Manual selection - Rejected: Error-prone and lacks audit trail
     - **Decision:** Use centralized router with fallback validation
     - **Evidence:** Router configuration and available protocols list
   
   * **2.1. Resolve Review Mode:**
       * Parse `/review --mode {target}` input or fallback rules to determine specialized protocol
       * Communication: `"[MASTER RAY‚Ñ¢ | PHASE 2 START] - Determining review mode '{mode}' via centralized router..."`
       * Halt condition: Suspend execution if router cannot map mode to protocol
       * Evidence: `.artifacts/quality-audit/mode-resolution.json` capturing requested mode, router decision, and fallback chain
       * Validation: Mode resolved with valid protocol
   
   * **2.2. Load Specialized Protocol Instructions:**
       * Fetch markdown from `.cursor/ai-driven-workflow/review-protocols/{protocol}.md` and register execution scope
       * Communication: `"[ROUTER] Specialized protocol '{protocol}' loaded for execution."`
       * Halt condition: Stop if file retrieval fails or integrity check mismatches expected hash
       * Evidence: `.artifacts/quality-audit/protocol-manifest.json` with hash, version, and dependencies
       * Validation: Protocol manifest checksum verification = true
   
   * **2.3. Validate Router Fallback Logic:**
       * Confirm router escalates from custom to generic protocol when custom file missing
       * Evidence: Fallback validation logged
       * Validation: Router fallback coverage = 100%

### PHASE 3: Specialized Protocol Execution Oversight

1. **`[STRICT]` Execute and Monitor Specialized Protocol:**
   * **3.1. Execute Selected Review Protocol:**
       * Follow instructions inside loaded protocol, delegating steps while capturing evidence references in orchestrator log
       * Communication: `"[MASTER RAY‚Ñ¢ | PHASE 3 START] - Executing specialized review protocol '{protocol}'..."`
       * Halt condition: Halt if specialized protocol reports blocking findings without mitigation
       * Evidence: `.artifacts/quality-audit/execution-log.md` enumerating steps, checks, and outcomes
       * Validation: 100% required checks executed
   
   * **3.2. Consolidate Findings Across Checks:**
       * Merge lint/test/security outputs into unified dataset `audit-findings.json` categorized by severity
       * Communication: `"[PHASE 3] Consolidating findings from specialized review outputs..."`
       * Halt condition: Pause if any required artifact missing from specialized run
       * Evidence: `.artifacts/quality-audit/audit-findings.json` plus severity summary chart `finding-summary.csv`
       * Validation: Zero unresolved blocker severity findings
   
   * **3.3. Trigger Extended Checks for Comprehensive Mode:**
       * When mode == `comprehensive`, sequence quick ‚Üí security ‚Üí architecture ‚Üí design ‚Üí ui reviews
       * Command: `python scripts/run_comprehensive_review.py --output .artifacts/quality-audit/comprehensive-trace.json`
       * Evidence: `.artifacts/quality-audit/comprehensive-trace.json`
       * Validation: All extended checks executed

### PHASE 4: Unified Reporting and Handoff Preparation

1. **`[STRICT]` Generate Audit Report Package:**
   * Compile CI, coverage, specialized findings, and router manifests into `QUALITY-AUDIT-PACKAGE.zip`
   * Communication: `"[MASTER RAY‚Ñ¢ | PHASE 4 START] - Packaging unified quality audit deliverables..."`
   * Halt condition: Stop if package checksum verification fails
   * Evidence: `.artifacts/quality-audit/quality-audit-manifest.json` plus zipped artifact
   * Validation: Manifest completeness score ‚â• 95%

2. **`[STRICT]` Issue Readiness Recommendation:**
   * Produce decision record (`go`, `go-with-risks`, `no-go`) referencing gate scores and mitigations
   * Communication: `"[RAY VALIDATION REQUEST] - Audit decision: {decision}. Confirm acceptance to proceed to UAT coordination?"`
   * Halt condition: Await stakeholder confirmation for `go-with-risks` or `no-go` outcomes
   * Evidence: `.artifacts/quality-audit/readiness-recommendation.md` detailing rationale and signatories
   * Validation: Approvals logged for decision

3. **`[GUIDELINE]` Publish Audit Summary to Context Kit:**
   * Update `.cursor/context-kit/quality-audit-summary.json` for rapid reuse in subsequent phases
   * Evidence: `.cursor/context-kit/quality-audit-summary.json`
   * Validation: Summary published

## Quality Gates

**`[STRICT]` All gates must pass before protocol completion:**

| Gate | Criteria | Pass Threshold | Evidence | Automation |
|------|----------|----------------|----------|------------|
| Gate 1: Pre-Audit Automation | CI workflows succeed; coverage ‚â• 80%; change-context artifact generated | Coverage ‚â• 80%, zero CI blocking errors | `ci-*-results.json`, `coverage-report.json`, `change-context.json` | `run_protocol_4_pre_audit.py` |
| Gate 2: Routing Integrity | Mode resolved with valid protocol manifest; router fallback validated | Manifest checksum verification = true; router fallback coverage = 100% | `mode-resolution.json`, `protocol-manifest.json` | `validate_router_mapping.py` |
| Gate 3: Execution Completion | Specialized protocol executed; all mandatory findings logged; blocking issues triaged | 100% required checks executed; zero unresolved blocker severity findings | `execution-log.md`, `audit-findings.json` | `verify_specialized_execution.py` |
| Gate 4: Unified Reporting | Audit package compiled; recommendation issued with signatures; artifacts checksum valid | Manifest completeness score ‚â• 95%; approvals logged for decision | `quality-audit-manifest.json`, `readiness-recommendation.md`, package checksum file | `validate_gate_4_reporting.py` |

**`[STRICT]` Gate Failure Handling:**
- Gate 1 failure: Halt audit, notify Protocol 21/9 owners, rerun automation after remediation
- Gate 2 failure: Escalate to workflow maintainer; patch router configuration before proceeding
- Gate 3 failure: Coordinate with specialized protocol owner; rerun after fixes or risk waivers
- Gate 4 failure: Rebuild package, obtain missing approvals, revalidate checksums

## Communication Protocols

**`[STRICT]` Use Status Announcements:**
```
[MASTER RAY‚Ñ¢ | PHASE 1 START] - Executing baseline CI workflows for quality audit enablement...
[MASTER RAY‚Ñ¢ | PHASE 1 COMPLETE] - Pre-audit automation complete. Evidence: ci-workflow-log.txt, coverage-report.json.
[MASTER RAY‚Ñ¢ | PHASE 2 START] - Determining review mode '{mode}' via centralized router...
[MASTER RAY‚Ñ¢ | PHASE 3 START] - Executing specialized review protocol '{protocol}'...
[MASTER RAY‚Ñ¢ | PHASE 4 START] - Packaging unified quality audit deliverables...
[MASTER RAY‚Ñ¢ | PHASE 4 COMPLETE] - Quality audit package ready. Evidence: QUALITY-AUDIT-PACKAGE.zip.
[RAY ERROR] - "Failed at {step}. Reason: {explanation}. Awaiting instructions."
```

**`[STRICT]` Validation Prompts:**
```
[RAY CONFIRMATION REQUIRED]
> "I have completed the quality audit automation and protocol execution. The following evidence is ready:
> - QUALITY-AUDIT-PACKAGE.zip
> - readiness-recommendation.md
> 
> Please review and confirm readiness to proceed to Protocol 13."
```

**`[STRICT]` Error Handling:**
```
[RAY GATE FAILED: Pre-Audit Automation Gate]
> "Quality gate 'Pre-Audit Automation Gate' failed.
> Criteria: CI workflows and coverage threshold
> Actual: Coverage 75% (below 80% threshold)
> Required action: Increase coverage to ‚â•80% or request waiver.
> 
> Options:
> 1. Fix issues and retry validation
> 2. Request gate waiver with justification
> 3. Halt protocol execution"
```

## Artifact Traceability

**`[STRICT]` Required Artifacts:**
- `ci-<workflow>-results.json` - Baseline CI validation evidence
- `coverage-report.json` - Coverage baseline for audit scope
- `coverage-metadata.yaml` - Coverage metadata
- `change-context.json` - Git diff summary
- `mode-resolution.json` - Mode resolution record
- `protocol-manifest.json` - Protocol manifest with hash
- `execution-log.md` - Protocol execution log
- `audit-findings.json` - Consolidated review findings
- `finding-summary.csv` - Severity summary chart
- `comprehensive-trace.json` - Comprehensive review trace (if applicable)
- `QUALITY-AUDIT-PACKAGE.zip` - Formal audit deliverables
- `quality-audit-manifest.json` - Audit manifest
- `readiness-recommendation.md` - Decision record with approvals
- `quality-audit-summary.json` - Snapshot for future contexts

**`[STRICT]` Traceability Requirements:**
- Each artifact includes: SHA-256 checksum, timestamp, verified_by field
- All findings trace to specialized protocol outputs
- All recommendations reference gate scores and mitigations
- All modifications logged in protocol execution log

## Protocol 13 Handoff Requirements

**`[STRICT]` Before initiating Protocol 13:**
1. All quality gates passed (Gate 1-4) or waivers documented
2. `QUALITY-AUDIT-PACKAGE.zip` compiled and accessible
3. `readiness-recommendation.md` contains decision record with approvals
4. `quality-audit-summary.json` published to context kit
5. All artifacts archived in `.artifacts/quality-audit/`
6. Manifest completeness score ‚â• 95%

### ‚úÖ Correct Implementation

**Example: Coverage Report**
```json
{
  "coverage_date": "2025-02-10T10:00:00Z",
  "overall_coverage": 85.5,
  "line_coverage": 83.2,
  "function_coverage": 87.8,
  "branch_coverage": 85.5,
  "threshold_met": true,
  "threshold": 80,
  "modules": [
    {
      "module": "payment-service",
      "coverage": 88.5,
      "status": "compliant"
    },
    {
      "module": "user-service",
      "coverage": 82.1,
      "status": "compliant"
    }
  ]
}
```

**Example: Mode Resolution**
```json
{
  "resolution_date": "2025-02-10T10:30:00Z",
  "requested_mode": "comprehensive",
  "router_decision": "comprehensive-review",
  "protocol_file": ".cursor/ai-driven-workflow/review-protocols/comprehensive-review.md",
  "fallback_chain": [],
  "protocol_loaded": true,
  "checksum": "sha256:abc123...",
  "checksum_verified": true
}
```

**Example: Audit Findings**
```json
{
  "findings_date": "2025-02-10T12:00:00Z",
  "total_findings": 15,
  "findings_by_severity": {
    "CRITICAL": 0,
    "HIGH": 2,
    "MEDIUM": 5,
    "LOW": 8
  },
  "findings": [
    {
      "id": "QA-001",
      "severity": "HIGH",
      "category": "security",
      "description": "Missing input validation in payment API",
      "location": "payment-service/api/payments.ts:45",
      "status": "resolved",
      "mitigation": "Added input validation middleware"
    },
    {
      "id": "QA-002",
      "severity": "MEDIUM",
      "category": "performance",
      "description": "Inefficient database query",
      "location": "user-service/repository/user.ts:120",
      "status": "waived",
      "mitigation": "Optimization scheduled for next sprint"
    }
  ],
  "unresolved_blockers": 0
}
```

**Example: Readiness Recommendation**
```markdown
# Quality Audit Readiness Recommendation

**Date:** 2025-02-10T14:00:00Z
**Decision:** go-with-risks
**Gate Scores:**
- Gate 1 (Pre-Audit Automation): PASS (95%)
- Gate 2 (Routing Integrity): PASS (100%)
- Gate 3 (Execution Completion): PASS (98%)
- Gate 4 (Unified Reporting): PASS (97%)

**Summary:**
Quality audit completed successfully with comprehensive review protocol execution. All gates passed with high scores. Two HIGH severity findings resolved, one MEDIUM severity finding waived with justification.

**Risks:**
- Performance optimization deferred to next sprint (waived)
- Monitoring improvements recommended for production

**Signatories:**
- Quality Engineer: Approved
- Engineering Lead: Approved
- Product Owner: Approved

**Recommendation:** Proceed to Protocol 13 (UAT Coordination) with monitoring plan in place.
```

### ‚ùå Anti-Patterns to Avoid

**Anti-Pattern 1: Bypassing Pre-Audit Automation**
```bash
# ‚ùå WRONG - Specialized protocol executed without pre-audit automation
[MASTER RAY‚Ñ¢ | PHASE 2 START] - Determining review mode...
# Missing: Phase 1 (CI workflows, coverage aggregation)
# Gate 1 cannot pass

# ‚úÖ CORRECT - Pre-audit automation executed first
[MASTER RAY‚Ñ¢ | PHASE 1 START] - Executing baseline CI workflows...
# CI workflows executed
# Coverage aggregated (85.5%)
# Change context generated
[MASTER RAY‚Ñ¢ | PHASE 2 START] - Determining review mode...
```
**Why:** Gate 1 requires CI workflows succeed and coverage ‚â• 80%. Bypassing pre-audit automation prevents baseline validation and causes incomplete audit results.

**Anti-Pattern 2: Coverage Below Threshold**
```json
// ‚ùå WRONG - Coverage below 80% threshold
{
  "overall_coverage": 75.5,
  "threshold_met": false,  // Below threshold
  "threshold": 80
}

// ‚úÖ CORRECT - Coverage meets threshold
{
  "overall_coverage": 85.5,
  "threshold_met": true,  // Meets threshold
  "threshold": 80
}
```
**Why:** Gate 1 requires coverage ‚â• 80%. Below-threshold coverage indicates insufficient test coverage and risks undetected defects.

**Anti-Pattern 3: Bypassing Specialized Protocol**
```bash
# ‚ùå WRONG - Report generated without executing specialized protocol
[MASTER RAY‚Ñ¢ | PHASE 3 START] - Executing specialized review protocol...
# Protocol execution skipped
[MASTER RAY‚Ñ¢ | PHASE 4 START] - Packaging unified quality audit deliverables...
# Report generated without protocol execution
# Gate 3 cannot pass

# ‚úÖ CORRECT - Specialized protocol executed end-to-end
[MASTER RAY‚Ñ¢ | PHASE 3 START] - Executing specialized review protocol 'comprehensive-review'...
# Protocol steps executed
# Findings consolidated
# Evidence captured
[MASTER RAY‚Ñ¢ | PHASE 4 START] - Packaging unified quality audit deliverables...
```
**Why:** Gate 3 requires specialized protocol executed and all mandatory findings logged. Bypassing protocol prevents comprehensive review and causes incomplete audit results.

**Anti-Pattern 4: Unresolved Blocker Findings**
```json
// ‚ùå WRONG - Blocker severity findings not resolved
{
  "findings_by_severity": {
    "CRITICAL": 1,  // Unresolved
    "HIGH": 2,
    "MEDIUM": 5
  },
  "unresolved_blockers": 1  // Blocks gate 3
}

// ‚úÖ CORRECT - All blocker findings resolved or waived
{
  "findings_by_severity": {
    "CRITICAL": 0,
    "HIGH": 0,  // All resolved
    "MEDIUM": 5  // Non-blocking
  },
  "unresolved_blockers": 0
}
```
**Why:** Gate 3 requires zero unresolved blocker severity findings. Unresolved blockers indicate critical issues that prevent release readiness.

**Anti-Pattern 5: Missing Router Fallback Validation**
```json
// ‚ùå WRONG - Router fallback not validated
{
  "router_decision": "comprehensive-review",
  "fallback_chain": [],  // Not validated
  "fallback_coverage": "unknown"
}

// ‚úÖ CORRECT - Router fallback validated
{
  "router_decision": "comprehensive-review",
  "fallback_chain": ["generic-review"],  // Validated
  "fallback_coverage": 100
}
```
**Why:** Gate 2 requires router fallback coverage = 100%. Missing fallback validation risks router failures without recovery path.

**Anti-Pattern 6: Incomplete Audit Package**
```bash
# ‚ùå WRONG - Package missing critical artifacts
QUALITY-AUDIT-PACKAGE.zip:
  ‚îú‚îÄ‚îÄ ci-test-results.json ‚úÖ
  ‚îú‚îÄ‚îÄ coverage-report.json ‚úÖ
  # Missing: audit-findings.json
  # Missing: readiness-recommendation.md
  # Manifest completeness < 95%

# ‚úÖ CORRECT - Complete audit package
QUALITY-AUDIT-PACKAGE.zip:
  ‚îú‚îÄ‚îÄ ci-test-results.json ‚úÖ
  ‚îú‚îÄ‚îÄ ci-lint-results.json ‚úÖ
  ‚îú‚îÄ‚îÄ coverage-report.json ‚úÖ
  ‚îú‚îÄ‚îÄ audit-findings.json ‚úÖ
  ‚îú‚îÄ‚îÄ finding-summary.csv ‚úÖ
  ‚îú‚îÄ‚îÄ readiness-recommendation.md ‚úÖ
  ‚îî‚îÄ‚îÄ quality-audit-manifest.json ‚úÖ
```
**Why:** Gate 4 requires manifest completeness score ‚â• 95%. Incomplete packages prevent comprehensive review and cause downstream protocol failures.

**Anti-Pattern 7: Missing Readiness Recommendation**
```bash
# ‚ùå WRONG - Audit completed but recommendation not issued
.artifacts/quality-audit/
  ‚îú‚îÄ‚îÄ QUALITY-AUDIT-PACKAGE.zip ‚úÖ
  # Missing: readiness-recommendation.md
  # Gate 4 cannot pass

# ‚úÖ CORRECT - Recommendation issued with decision
.artifacts/quality-audit/
  ‚îú‚îÄ‚îÄ QUALITY-AUDIT-PACKAGE.zip ‚úÖ
  ‚îî‚îÄ‚îÄ readiness-recommendation.md ‚úÖ (with decision: go/go-with-risks/no-go)
```
**Why:** Gate 4 requires recommendation issued with signatures. Missing recommendations prevent stakeholder decision-making and block protocol handoff.

**Anti-Pattern 8: Protocol Manifest Checksum Mismatch**
```json
// ‚ùå WRONG - Checksum verification failed
{
  "protocol_file": "comprehensive-review.md",
  "expected_checksum": "sha256:abc123...",
  "actual_checksum": "sha256:xyz789...",
  "checksum_verified": false  // Mismatch
}

// ‚úÖ CORRECT - Checksum verification passed
{
  "protocol_file": "comprehensive-review.md",
  "expected_checksum": "sha256:abc123...",
  "actual_checksum": "sha256:abc123...",
  "checksum_verified": true  // Match
}
```
**Why:** Gate 2 requires manifest checksum verification = true. Checksum mismatches indicate protocol file corruption or tampering, preventing safe execution.
