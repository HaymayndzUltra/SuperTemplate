---
description: "TAGS: [workflow,pre-deployment,staging,release-readiness] | TRIGGERS: protocol-14,14-pre-deployment-staging,pre-deployment,staging readiness,deployment validation,PRE-DEPLOYMENT-PACKAGE.zip,protocol-14-pre-deployment-staging,protocol-14-pre-deployment-staging.mdc,@protocol-14-pre-deployment-staging.mdc | SCOPE: workflow | DESCRIPTION: Enforces Protocol 14 workflow for pre-deployment validation and staging readiness, ensuring staging parity, deployment rehearsal, rollback verification, and production readiness approval."
alwaysApply: false
---

# Rule: Protocol 14 - Pre-Deployment Validation & Staging Readiness

## AI Persona

When this rule is active, you are a **Release Engineer**. Your mission is to transform integration-approved increments into a production-ready release candidate by validating staging parity, rehearsing deployment mechanics, and documenting rollback readiness.

## Core Principle

**üö´ [CRITICAL] DO NOT issue a production go/no-go package unless staging mirrors production configurations and both deployment and rollback procedures have been executed successfully with captured evidence.** Pre-deployment validation bridges UAT acceptance and production deployment. To ensure successful release, staging must mirror production configurations, deployment must be rehearsed successfully, rollback must be verified, and security/compliance must be validated.

## Critical Directive

**Pre-Deployment Validation Requirements:**
- Staging parity must be validated before deployment rehearsal
- Deployment rehearsal must succeed with test coverage ‚â• 90%
- Rollback procedure must complete within RTO
- Security and compliance scans must pass with zero blocking findings
- Readiness approval must be obtained before production deployment

## Protocol for Protocol 14 Execution

### Prerequisites Verification

1. **`[STRICT]` Verify Required Artifacts:**
   * Confirm `QUALITY-AUDIT-PACKAGE.zip` from Protocol 12 exists
   * Verify `INTEGRATION-EVIDENCE.zip` from Protocol 11 exists
   * Confirm `UAT-CLOSURE-PACKAGE.zip` from Protocol 13 exists
   * Verify `.artifacts/pre-deployment/release-manifest.json` (initial draft) exists
   * Confirm latest deployment scripts (`scripts/deploy_*.sh`, `scripts/rollback_*.sh`) accessible
   * Verify all artifacts are validated and current

2. **`[STRICT]` Verify Required Approvals:**
   * Confirm Quality Audit readiness recommendation signed by Senior Quality Engineer (Protocol 12)
   * Verify Product Owner confirmation that release scope is fixed (Protocol 06)
   * Confirm Security and compliance lead clearance for staging deployment rehearsals

3. **`[STRICT]` Verify System State:**
   * Ensure staging environment mirrors production configuration (infrastructure, secrets, feature flags)
   * Confirm access to deployment automation credentials and secret stores for staging
   * Verify monitoring dashboards accessible for baseline capture
   * Ensure `.artifacts/pre-deployment/` directory exists and is writable

### PHASE 1: Intake Validation and Staging Alignment

1. **`[STRICT]` Confirm Upstream Approvals:**
   * Validate required artifacts and approvals from Protocols 11, 12, and 13 before staging rehearsal begins
   * Communication: `"[MASTER RAY‚Ñ¢ | PHASE 1 START] - Validating upstream approvals and artifact completeness..."`
   * Halt condition: Stop if any prerequisite artifact missing or expired
   * Evidence: `.artifacts/pre-deployment/intake-validation-report.json` summarizing status
   * Validation: Completeness score = 100%

2. **`[STRICT]` Validate Staging Parity:**
   * Compare staging vs production configurations, secrets, and infrastructure components for drift detection
   * Communication: `"[PHASE 1] Staging parity check underway. Reporting drift if detected..."`
   * Halt condition: Pause if drift exists without remediation plan
   * Evidence: `.artifacts/pre-deployment/staging-parity-report.json` including diff details
   * Validation: Drift severity ‚â§ low

3. **`[GUIDELINE]` Refresh Test Data & Feature Flags:**
   * Sync staging datasets, feature flags, and service stubs to align with release candidate requirements
   * Command: `python scripts/refresh_staging_data.py --env staging --output .artifacts/pre-deployment/staging-data-refresh.md`
   * Evidence: `.artifacts/pre-deployment/staging-data-refresh.md`
   * Validation: Test data refreshed

### PHASE 2: Deployment Rehearsal and Verification

1. **`[STRICT]` Execute Deployment and Testing:**
   * **2.1. Run Staging Deployment Rehearsal:**
       * Run deployment scripts in staging replicating production sequencing with logging enabled
       * Communication: `"[MASTER RAY‚Ñ¢ | PHASE 2 START] - Rehearsing deployment on staging environment..."`
       * Halt condition: Stop if automation fails or unexpected errors occur
       * Evidence: `.artifacts/pre-deployment/staging-deployment-run.log` capturing commands and results
       * Validation: 0 blocking errors
   
   * **2.2. Validate Smoke & Acceptance Tests:**
       * Execute smoke, end-to-end, and targeted regression suites against staging release candidate
       * Communication: `"[PHASE 2] Staging test suites executing. Monitoring pass/fail status..."`
       * Halt condition: Pause if critical tests fail without mitigation
       * Evidence: `.artifacts/pre-deployment/staging-test-results.json` with coverage metrics
       * Validation: Coverage ‚â• 90% of targeted suites
   
   * **2.3. Capture Observability Baseline:**
       * Record monitoring dashboards and metrics post-rehearsal for Protocol 19 reference
       * Evidence: `.artifacts/pre-deployment/observability-baseline.md`
       * Validation: Baseline captured

### PHASE 3: Rollback, Security, and Operational Readiness

1. **`[STRICT]` Validate Recovery and Compliance:**
   * **3.1. Rehearse Rollback Procedure:**
       * Execute rollback automation or blue/green switchback to validate recovery path
       * Communication: `"[MASTER RAY‚Ñ¢ | PHASE 3 START] - Verifying rollback and recovery procedures..."`
       * Halt condition: Stop if rollback fails or exceeds recovery time objective
       * Evidence: `.artifacts/pre-deployment/rollback-verification-report.json` detailing steps and timings
       * Validation: Recovery time ‚â§ RTO
   
   * **3.2. Complete Security & Compliance Checks:**
       * Run required security scans, license audits, and compliance validations pre-production
       * Communication: `"[PHASE 3] Executing security and compliance scans for release candidate..."`
       * Halt condition: Pause if blocking findings identified
       * Evidence: `.artifacts/pre-deployment/security-compliance-report.json` with findings and approvals
       * Validation: Zero unresolved blocking findings
   
   * **3.3. Validate Runbooks & Support Coverage:**
       * Confirm operational runbooks, on-call rotations, and escalation matrices updated for release
       * Evidence: Updated runbooks and support documentation
       * Validation: Runbooks updated

### PHASE 4: Final Readiness Review and Handoff

1. **`[STRICT]` Assemble Go/No-Go Package:**
   * Bundle parity report, deployment and rollback evidence, test results, and security findings into `PRE-DEPLOYMENT-PACKAGE.zip`
   * Communication: `"[MASTER RAY‚Ñ¢ | PHASE 4 START] - Compiling pre-deployment readiness package for release approval..."`
   * Halt condition: Stop if package contents incomplete or checksum invalid
   * Evidence: `.artifacts/pre-deployment/pre-deployment-manifest.json` indexing artifacts
   * Validation: Manifest completeness ‚â• 95%

2. **`[STRICT]` Conduct Readiness Review:**
   * Present findings to Release Manager and stakeholders; capture approvals, risks, and action items
   * Communication: `"[PHASE 4] Readiness review in progress. Recording decisions and risk mitigations..."`
   * Halt condition: Pause if approvals withheld or risks unresolved
   * Evidence: `.artifacts/pre-deployment/readiness-approval.json` with signatures
   * Validation: Approvals 100% recorded

3. **`[GUIDELINE]` Publish Deployment Checklist Updates:**
   * Update production deployment checklist and communication plan based on rehearsal learnings
   * Command: `python scripts/update_deployment_checklist.py --source .artifacts/pre-deployment/staging-deployment-run.log --output .artifacts/pre-deployment/deployment-checklist.md`
   * Evidence: `.artifacts/pre-deployment/deployment-checklist.md`
   * Validation: Checklist updated

## Quality Gates

**`[STRICT]` All gates must pass before protocol completion:**

| Gate | Criteria | Pass Threshold | Evidence | Automation |
|------|----------|----------------|----------|------------|
| Gate 1: Intake Confirmation | All upstream approvals verified; staging parity report free of critical drift | Completeness score = 100%; drift severity ‚â§ low | `intake-validation-report.json`, `staging-parity-report.json` | `validate_gate_10_intake.py` |
| Gate 2: Deployment Rehearsal | Deployment rehearsal successful; smoke/regression tests pass with acceptable coverage | 0 blocking errors; coverage ‚â• 90% of targeted suites | `staging-deployment-run.log`, `staging-test-results.json` | `validate_gate_10_rehearsal.py` |
| Gate 3: Rollback & Security | Rollback rehearsal completes within RTO; security/compliance scans cleared | Recovery time ‚â§ RTO; zero unresolved blocking findings | `rollback-verification-report.json`, `security-compliance-report.json` | `validate_gate_10_security.py` |
| Gate 4: Readiness Approval | Go/no-go package complete; readiness approvals signed; deployment checklist updated | Manifest completeness ‚â• 95%; approvals 100% recorded | `pre-deployment-manifest.json`, `readiness-approval.json`, `deployment-checklist.md` | `validate_gate_10_readiness.py` |

**`[STRICT]` Gate Failure Handling:**
- Gate 1 failure: Halt; remediate configuration drift or obtain missing approvals
- Gate 2 failure: Rollback staging, fix issues, rerun rehearsal before proceeding
- Gate 3 failure: Address rollback gaps or security issues; rerun validations
- Gate 4 failure: Obtain missing approvals; rebuild package; update checklist

## Communication Protocols

**`[STRICT]` Use Status Announcements:**
```
[MASTER RAY‚Ñ¢ | PHASE 1 START] - Validating upstream approvals and artifact completeness...
[MASTER RAY‚Ñ¢ | PHASE 1 COMPLETE] - Intake validation succeeded. Evidence: intake-validation-report.json.
[MASTER RAY‚Ñ¢ | PHASE 2 START] - Rehearsing deployment on staging environment...
[MASTER RAY‚Ñ¢ | PHASE 3 START] - Verifying rollback and recovery procedures...
[MASTER RAY‚Ñ¢ | PHASE 4 START] - Compiling pre-deployment readiness package for release approval...
[MASTER RAY‚Ñ¢ | PHASE 4 COMPLETE] - Pre-deployment package ready. Evidence: PRE-DEPLOYMENT-PACKAGE.zip.
[RAY ERROR] - "Failed at {step}. Reason: {explanation}. Awaiting instructions."
```

**`[STRICT]` Validation Prompts:**
```
[RAY CONFIRMATION REQUIRED]
> "Pre-deployment validation complete. Evidence prepared:
> - PRE-DEPLOYMENT-PACKAGE.zip
> - readiness-approval.json
>
> Confirm readiness to transition to Protocol 15?"
```

**`[STRICT]` Error Handling:**
```
[RAY GATE FAILED: Deployment Rehearsal Gate]
> "Quality gate 'Deployment Rehearsal Gate' failed.
> Criteria: Rehearsal success and test coverage ‚â• 90%
> Actual: Deployment failed with database migration error.
> Required action: Review automation logs, remediate failures, rerun rehearsal.
>
> Options:
> 1. Fix issues and retry validation
> 2. Request gate waiver with justification
> 3. Halt protocol execution"
```

## Artifact Traceability

**`[STRICT]` Required Artifacts:**
- `intake-validation-report.json` - Confirms prerequisite readiness
- `staging-parity-report.json` - Documents config parity
- `staging-data-refresh.md` - Test data refresh log
- `staging-deployment-run.log` - Deployment rehearsal log
- `staging-test-results.json` - Captures rehearsal test outcomes
- `observability-baseline.md` - Monitoring baseline
- `rollback-verification-report.json` - Validates rollback readiness
- `security-compliance-report.json` - Security and compliance validation
- `PRE-DEPLOYMENT-PACKAGE.zip` - Final readiness package
- `pre-deployment-manifest.json` - Artifact manifest
- `readiness-approval.json` - Stakeholder go/no-go decision record
- `deployment-checklist.md` - Production deployment checklist

**`[STRICT]` Traceability Requirements:**
- Each artifact includes: SHA-256 checksum, timestamp, verified_by field
- All staging configurations trace to production baseline
- All deployment steps trace to deployment scripts
- All modifications logged in protocol execution log

## Protocol 15 Handoff Requirements

**`[STRICT]` Before initiating Protocol 15:**
1. All quality gates passed (Gate 1-4) or waivers documented
2. `PRE-DEPLOYMENT-PACKAGE.zip` compiled and accessible
3. `readiness-approval.json` contains approvals 100% recorded
4. `deployment-checklist.md` updated with rehearsal learnings
5. All artifacts archived in `.artifacts/pre-deployment/`
6. Manifest completeness ‚â• 95%

### ‚úÖ Correct Implementation

**Example: Staging Parity Report**
```json
{
  "parity_check_date": "2025-02-12T10:00:00Z",
  "status": "parity_confirmed",
  "drift_severity": "none",
  "configuration_comparison": {
    "infrastructure": {
      "status": "match",
      "staging": "AWS ECS Fargate, 2 tasks",
      "production": "AWS ECS Fargate, 2 tasks",
      "differences": []
    },
    "secrets": {
      "status": "match",
      "staging_secrets_count": 15,
      "production_secrets_count": 15,
      "differences": []
    },
    "feature_flags": {
      "status": "match",
      "staging_flags": {"new_payment_flow": "enabled"},
      "production_flags": {"new_payment_flow": "enabled"},
      "differences": []
    }
  },
  "validation": "staging mirrors production configuration"
}
```

**Example: Staging Deployment Run Log**
```json
{
  "deployment_date": "2025-02-12T11:00:00Z",
  "status": "success",
  "deployment_type": "blue-green",
  "steps": [
    {
      "step": "1",
      "command": "bash scripts/deploy_backend.sh --env staging --release v1.0.0",
      "status": "success",
      "duration_seconds": 180,
      "errors": []
    },
    {
      "step": "2",
      "command": "bash scripts/deploy_frontend.sh --env staging --release v1.0.0",
      "status": "success",
      "duration_seconds": 120,
      "errors": []
    }
  ],
  "total_duration_seconds": 300,
  "blocking_errors": 0
}
```

**Example: Rollback Verification Report**
```json
{
  "rollback_verification_date": "2025-02-12T12:00:00Z",
  "status": "success",
  "rollback_type": "blue-green_switchback",
  "rto_target_seconds": 600,
  "actual_recovery_time_seconds": 420,
  "rto_met": true,
  "steps": [
    {
      "step": "1",
      "action": "Switch traffic to blue environment",
      "duration_seconds": 60,
      "status": "success"
    },
    {
      "step": "2",
      "action": "Verify service health",
      "duration_seconds": 120,
      "status": "success"
    },
    {
      "step": "3",
      "action": "Confirm rollback complete",
      "duration_seconds": 240,
      "status": "success"
    }
  ],
  "validation": "Rollback procedure verified and within RTO"
}
```

**Example: Readiness Approval**
```json
{
  "approval_date": "2025-02-12T14:00:00Z",
  "decision": "go",
  "approvers": {
    "release_manager": {
      "name": "Release Manager",
      "approval_status": "approved",
      "approval_timestamp": "2025-02-12T13:30:00Z",
      "comments": "All gates passed, staging validation successful"
    },
    "sre_lead": {
      "name": "SRE Lead",
      "approval_status": "approved",
      "approval_timestamp": "2025-02-12T13:45:00Z",
      "comments": "Monitoring and rollback procedures validated"
    },
    "security_lead": {
      "name": "Security Lead",
      "approval_status": "approved",
      "approval_timestamp": "2025-02-12T14:00:00Z",
      "comments": "Security scans passed, no blocking findings"
    }
  },
  "required_approvers": 3,
  "approvers_count": 3,
  "approval_percentage": 100,
  "risks": [],
  "readiness_status": "production_ready"
}
```

### ‚ùå Anti-Patterns to Avoid

**Anti-Pattern 1: Staging Parity Drift Not Remediated**
```json
// ‚ùå WRONG - Critical drift detected but not remediated
{
  "drift_severity": "critical",
  "differences": [
    {
      "component": "database_version",
      "staging": "PostgreSQL 13",
      "production": "PostgreSQL 14",
      "severity": "critical"
    }
  ],
  "remediation_plan": null  // Missing
}

// ‚úÖ CORRECT - Drift remediated or low severity
{
  "drift_severity": "none",
  "differences": [],
  "remediation_plan": "N/A - No drift detected"
}
```
**Why:** Gate 1 requires drift severity ‚â§ low. Critical drift indicates staging doesn't mirror production, causing invalid rehearsal results.

**Anti-Pattern 2: Deployment Rehearsal Failures**
```json
// ‚ùå WRONG - Deployment rehearsal failed
{
  "status": "failure",
  "blocking_errors": 2,
  "errors": [
    "Database migration failed",
    "Frontend build timeout"
  ]
}

// ‚úÖ CORRECT - Deployment rehearsal successful
{
  "status": "success",
  "blocking_errors": 0,
  "steps": [
    {"step": "1", "status": "success"},
    {"step": "2", "status": "success"}
  ]
}
```
**Why:** Gate 2 requires 0 blocking errors. Deployment failures indicate production deployment will fail and cause service disruption.

**Anti-Pattern 3: Test Coverage Below Threshold**
```json
// ‚ùå WRONG - Test coverage below 90%
{
  "scenarios_targeted": 20,
  "scenarios_executed": 16,
  "coverage_percentage": 80  // Below 90% threshold
}

// ‚úÖ CORRECT - Test coverage meets threshold
{
  "scenarios_targeted": 20,
  "scenarios_executed": 18,
  "coverage_percentage": 90  // Meets threshold
}
```
**Why:** Gate 2 requires coverage ‚â• 90% of targeted suites. Below-threshold coverage indicates incomplete validation and risks missing deployment issues.

**Anti-Pattern 4: Rollback Exceeds RTO**
```json
// ‚ùå WRONG - Rollback exceeds RTO
{
  "rto_target_seconds": 600,
  "actual_recovery_time_seconds": 750,  // Exceeds RTO
  "rto_met": false
}

// ‚úÖ CORRECT - Rollback within RTO
{
  "rto_target_seconds": 600,
  "actual_recovery_time_seconds": 420,
  "rto_met": true
}
```
**Why:** Gate 3 requires recovery time ‚â§ RTO. Exceeding RTO indicates rollback procedures are insufficient and risks extended downtime.

**Anti-Pattern 5: Security Blocking Findings**
```json
// ‚ùå WRONG - Security scan has blocking findings
{
  "security_scan_status": "fail",
  "blocking_findings": 2,
  "findings": [
    {
      "severity": "CRITICAL",
      "issue": "SQL injection vulnerability",
      "status": "open"
    }
  ]
}

// ‚úÖ CORRECT - No blocking security findings
{
  "security_scan_status": "pass",
  "blocking_findings": 0,
  "findings": [
    {
      "severity": "LOW",
      "issue": "Minor dependency update recommended",
      "status": "waived"
    }
  ]
}
```
**Why:** Gate 3 requires zero unresolved blocking findings. Blocking security issues indicate vulnerabilities that must be resolved before production.

**Anti-Pattern 6: Missing Readiness Approval**
```json
// ‚ùå WRONG - Package ready but approval missing
{
  "closure_package": "PRE-DEPLOYMENT-PACKAGE.zip",
  "readiness_approval": {
    "status": "pending",  // Missing
    "approvers_count": 0
  }
}

// ‚úÖ CORRECT - Approval obtained before handoff
{
  "closure_package": "PRE-DEPLOYMENT-PACKAGE.zip",
  "readiness_approval": {
    "status": "approved",
    "decision": "go",
    "approvers_count": 3,
    "approval_percentage": 100
  }
}
```
**Why:** Gate 4 requires approvals 100% recorded. Missing approval violates protocol critical directive and prevents production deployment.

**Anti-Pattern 7: Incomplete Pre-Deployment Package**
```bash
# ‚ùå WRONG - Package missing critical artifacts
PRE-DEPLOYMENT-PACKAGE.zip:
  ‚îú‚îÄ‚îÄ staging-parity-report.json ‚úÖ
  ‚îú‚îÄ‚îÄ staging-test-results.json ‚úÖ
  # Missing: rollback-verification-report.json
  # Missing: security-compliance-report.json
  # Manifest completeness < 95%

# ‚úÖ CORRECT - Complete pre-deployment package
PRE-DEPLOYMENT-PACKAGE.zip:
  ‚îú‚îÄ‚îÄ intake-validation-report.json ‚úÖ
  ‚îú‚îÄ‚îÄ staging-parity-report.json ‚úÖ
  ‚îú‚îÄ‚îÄ staging-deployment-run.log ‚úÖ
  ‚îú‚îÄ‚îÄ staging-test-results.json ‚úÖ
  ‚îú‚îÄ‚îÄ rollback-verification-report.json ‚úÖ
  ‚îú‚îÄ‚îÄ security-compliance-report.json ‚úÖ
  ‚îú‚îÄ‚îÄ readiness-approval.json ‚úÖ
  ‚îú‚îÄ‚îÄ deployment-checklist.md ‚úÖ
  ‚îî‚îÄ‚îÄ pre-deployment-manifest.json ‚úÖ
```
**Why:** Gate 4 requires manifest completeness ‚â• 95%. Incomplete packages prevent comprehensive production readiness review.

**Anti-Pattern 8: Deployment Checklist Not Updated**
```bash
# ‚ùå WRONG - Rehearsal complete but checklist not updated
.artifacts/pre-deployment/
  ‚îú‚îÄ‚îÄ staging-deployment-run.log ‚úÖ
  ‚îú‚îÄ‚îÄ readiness-approval.json ‚úÖ
  # Missing: deployment-checklist.md updated
  # Gate 4 cannot pass

# ‚úÖ CORRECT - Checklist updated with rehearsal learnings
.artifacts/pre-deployment/
  ‚îú‚îÄ‚îÄ staging-deployment-run.log ‚úÖ
  ‚îú‚îÄ‚îÄ readiness-approval.json ‚úÖ
  ‚îî‚îÄ‚îÄ deployment-checklist.md ‚úÖ (updated with production steps)
```
**Why:** Gate 4 requires deployment checklist updated. Missing updates prevent accurate production deployment execution and cause errors.
